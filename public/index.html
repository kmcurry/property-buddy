<!DOCTYPE html>
<html>

<head>
  <title>Property Buddy</title>
  <meta charset="utf-8">
  <style type="text/css">
    body {
      font-family: sans-serif;
      font-size: 1.5em;
      text-align: center;
    }

    ul {
      list-style-type: none;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    li {
      float: left;
      font-size: 1.75em;
      width: 100px;
    }

    #msg {
      font-size: 3em;
      /*-webkit-text-stroke: 2px gray;*/
    }

    .level {
      font-size: 4em;
      margin-top: 0px;
    }

    .preamble {
      margin-top: 20px;
      margin-bottom: 0px;
    }

    .no-zone {
      background-color: #00ff00;
    }

    ._50 {
      background-color: #55ff00;
      color: Gray
    }

    ._55 {
      background-color: #80ff00;
      color: Gray
    }

    ._60 {
      background-color: #aaff00;
      color: Gray
    }

    ._65 {
      background-color: #d5ff00;
      color: Gray
    }

    ._70 {
      background-color: #ffff00;
      color: Gray
    }

    ._75 {
      background-color: #ffd500;
      color: Gray
    }

    ._80 {
      background-color: #ff5500;
      color: Gray
    }

    ._85 {
      background-color: #ff0000;
      color: Gray
    }

    .scheme {
      display: inline-block;
      max-width: 100%;
      padding: 0;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="scheme">
    <ul>
      <li style="background-color:#00ff00;">
        0
      </li>
      <li style="background-color:#55ff00;">
        50
      </li>
      <li style="background-color:#80ff00;">
        55
      </li>
      <li style="background-color:#aaff00;">
        60
      </li>
      <li style="background-color:#d5ff00;">
        65
      </li>
      <li style="background-color:#ffff00;">
        70
      </li>
      <li style="background-color:#ffd500;">
        75
      </li>
      <li style="background-color:#ff5500;">
        80
      </li>
      <li style="background-color:#ff0000;">
        85
      </li>
    </ul>
  </div>
  <div id="msg">
    <p>Searching...</p>
  </div>
</body>

<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3js.org/d3-collection.v1.min.js"></script>
<script src="//d3js.org/d3-dispatch.v1.min.js"></script>
<script src="//d3js.org/d3-dsv.v1.min.js"></script>
<script src="//d3js.org/d3-request.v1.min.js"></script>
<script src="//d3js.org/d3-array.v1.min.js"></script>
<script src="//d3js.org/d3-geo.v1.min.js"></script>
<script src="/bower_components/jquery/dist/jquery.min.js"></script>
<script>
  function checkAICUZ(position) {

    console.log("Checking AICUZ for position:");
    console.log(position);

    var ll = [position.coords.longitude, position.coords.latitude];
    //var ll = [-76.195987, 36.893076]; // NFK

    d3.json("geojson/Norfolk.geo.json", function(error, mapData) {
      console.log("Checking " + ll + " in NFK");
      var features = mapData.features[0];
      if (d3.geoContains(features, ll)) {
        console.log("Location is NFK");
        checkAICUZ_NFK(ll);
      } else {
        console.log("Location is not in NFK")
      }
    });

    d3.json("geojson/VirginiaBeach.geo.json", function(error, mapData) {
      console.log("Checking " + ll + " in VB");
      var features = mapData.features[0];
      if (d3.geoContains(features, ll)) {
        console.log("Location is VB");
        checkAICUZ_VB(ll);
        //checkFloodZone_VB(ll);
      } else {
        console.log("Location is not in VB")
      }
    });

  }

  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(checkAICUZ);
    } else {
      d3.select("body").append("span")
        .text("Geolocation is not supported by this browser.");
    }
  }

  function checkAICUZ_NFK(ll) {
    d3.request("https://data-orf.opendata.arcgis.com/datasets/c8de1a1f81e14eacbe381ae342318031_8.geojson")
      .mimeType("application/json")
      .response(function(xhr) {
        return JSON.parse(xhr.responseText);
      })
      .get(function(data) {

        var msg = "<p class='preamble'>You are in Norfolk AICUZ Noise Zone:</p>";

        msg += checkFeaturesForNoiseLevel(data.features, ll, "NFK");


        d3.select("#msg").html(msg);

      });
  }

  function checkAICUZ_VB(ll) {
    d3.request("https://gis-vbgov.opendata.arcgis.com/datasets/3088488c6c284f3981d61b9efe9c1d04_3.geojson")
      .mimeType("application/json")
      .response(function(xhr) {
        return JSON.parse(xhr.responseText);
      })
      .get(function(data) {

        var msg = "<p class='preamble'>You are in Virginia Beach AICUZ Noise Zone:</p>";

        msg += checkFeaturesForNoiseLevel(data.features, ll, "VB");

        d3.select("#msg").html(msg);

      });
  }

  function checkFloodZone_VB(ll) {
    d3.request("https://gis-vbgov.opendata.arcgis.com/datasets/3088488c6c284f3981d61b9efe9c1d04_3.geojson")
      .mimeType("application/json")
      .response(function(xhr) {
        return JSON.parse(xhr.responseText);
      })
      .get(function(data) {

        var msg = "<p class='preamble'>You are in Virginia Beach Flood Zone:</p>";

        msg += checkFeaturesForFloodZone(data.features, ll, "VB");

        d3.select("#msg").html(msg);

      });
  }

  function checkFeaturesForNoiseLevel(features, ll, city) {
    var msg = "";
    var lvl = 0;
    $(features).each(function() {
      var f = $(this);
      if (f && f[0]) {
        if (d3.geoContains(f[0], ll)) {
          switch (city) {
            case "NFK":
              {
                lvl = parseInt(f[0].properties.NOISE_LEV_);
                msg += "<p class='level'>" + lvl + "</p>";

              }
              break;
            case "VB":
              {
                lvl = parseInt(f[0].properties.ZONE_);
                msg += "<p class='level'>" + lvl + "</p>";

              }
              break;
            default:
              {
                msg += "<p>You are NOT in any AICUZ Noise Zone</p>";
              }

          }
          return;
        }
      }

    })
    switch (lvl) {
      case 50:
        {
          d3.select("#msg").classed("_50", true);
        }
        break;
      case 55:
        {
          d3.select("#msg").classed("_55", true);
        }
        break;
      case 60:
        {
          d3.select("#msg").classed("_60", true);
        }
        break;
      case 65:
        {
          d3.select("#msg").classed("_65", true);
        }
        break;
      case 70:
        {
          d3.select("#msg").classed("_70", true);
        }
        break;
      case 75:
        {
          d3.select("#msg").classed("_75", true);
        }
        break;
      case 80:
        {
          d3.select("#msg").classed("_80", true);
        }
        break;
      case 85:
        {
          d3.select("#msg").classed("_85", true);
        }
        break;
    }
    return msg;
  }

  $(document).ready(function() {
    getLocation();
  })
</script>

</html>
